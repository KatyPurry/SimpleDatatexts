name: CurseForge Comment Notifications

on:
  schedule:
    - cron: "*/10 * * * *" # every 10 minutes
  workflow_dispatch:

jobs:
  scrape-comments:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install puppeteer node-fetch
        
      # --- Download previous state artifact if it exists ---
      - name: Restore CurseForge state cache
        uses: actions/cache@v3
        with:
          path: cf-state/curseforge-state.json
          key: sdt-lss-eldb-curseforge-state-v1

      - name: Scrape CurseForge comments and post to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          node <<'EOF'
          import puppeteer from "puppeteer";
          import fs from "fs";
          import fetch from "node-fetch";

          const PROJECTS = [
            { slug: "simpledatatexts", name: "SimpleDatatexts" },
            { slug: "lootspecswapper", name: "Loot Spec Swapper" },
            { slug: "emoteldb", name: "EmoteLDB" }
          ];

          const stateDir = "cf-state";
          const stateFile = `${stateDir}/curseforge-state.json`;
          fs.mkdirSync(stateDir, { recursive: true });
          
          let state = {};
          if (fs.existsSync(stateFile)) {
            try {
              const content = fs.readFileSync(stateFile, "utf-8").trim();
              state = content ? JSON.parse(content) : {};
            } catch (e) {
              console.log(`Warning: Failed to parse previous state, starting fresh.`);
              state = {};
            }
          }

          const browser = await puppeteer.launch({ args: ["--no-sandbox"] });
          const page = await browser.newPage();

          for (const project of PROJECTS) {
            const url = `https://www.curseforge.com/wow/addons/${project.slug}/comments`;
            try {
              await page.goto(url, { waitUntil: "networkidle2" });
              await page.waitForSelector(".comment", { timeout: 5000 });

              const comments = await page.$$eval(".comment", nodes =>
                nodes.map(node => {
                  const id = node.querySelector(".num")?.innerText?.trim() || "unknown";
                  const author = node.querySelector(".author-name .ellipsis")?.innerText?.trim() || "Unknown";
                  const body = node.querySelector(".text p")?.innerText?.trim() || "";
                  return { id, author, body }
                })
              );
              
              if (!comments.length) console.log(`No comments found for ${project.name}`);

              for (const comment of comments.reverse()) {
                const lastId = state[project.slug] || 0;
                if (parseInt(comment.id) <= lastId) continue;

                const msg = {
                  content: `ðŸ’¬ **New CurseForge comment on ${project.name}**\n` +
                           `Author: **${comment.author}**\n` +
                           `${comment.body.substring(0, 1800)}` +
                           `ðŸ”— [View comments](${url})`
                };
                
                function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

                try {
                  const res = await fetch(process.env.DISCORD_WEBHOOK, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(msg)
                  });
                  if (!res.ok) console.log(`Failed to post to Discord for ${project.name}: ${res.status}`);
                  await sleep(1000);
                } catch (e) {
                  console.log(`Error posting to Discord for ${project.name}:`, e.message);
                }
                
                // Log comment for debugging
                console.log(`--- ${project.name} ---`);
                console.log('ID:    ', comment.id);
                console.log('Author:', comment.author);
                console.log('Body:  ', comment.body);
                console.log('-------------------');

                state[project.slug] = parseInt(comment.id);
              }

            } catch (e) {
              console.log(`Error scraping ${project.name}:`, e.message);
            }
          }

          await browser.close();
          
          // Save updated state
          fs.writeFileSync(stateFile, JSON.stringify(state, null, 2));
          EOF

      # --- Upload the state file as an artifact ---
      - name: List state folder contents
        run: ls -l cf-state

      - name: Save CurseForge state cache
        uses: actions/cache@v3
        with:
          path: cf-state/curseforge-state.json
          key: sdt-lss-eldb-curseforge-state-v1
